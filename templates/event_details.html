<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <title>{{ events['EventName'] }} - Event Details</title>
    </head>
        <body>
            <header>
                <h1>{{ events['EventName'] }}</h1>
            </header>
            <nav>
                {% if not session.logged_in %}
                <a href="{{ url_for('login') }}">Login</a>
                {% else %}
                <div class="logout-container">
                    <button type="submit" class="logout-btn" onclick="window.location.href='/logout'">&#128274; Logout</button>
                </div>
                {% endif %}
            </nav>

            <div class="tabs">
                <button type="submit" class="tab-button active" onclick="openTab(event, 'overview')">Overview</button>
                <button type="submit" class="tab-button" onclick="openTab(event, 'more-info')">More Info</button>
                <button type="submit" class="tab-button" onclick="openTab(event, 'tickets')">Tickets</button>
            </div>

            <section id="overview" class="tab-content active">
                <h2>Event Information</h2>
                <p><strong>Date:</strong> {{ events['EventDate'] }}</p>
                <p><strong>Time:</strong> {{ events['StartTime'] }} - {{ events['EndTime'] }}</p>
                <p><strong>Description:</strong> {{ events['Description'] }}</p>
                <p><strong>Status:</strong> {{ events['Status'] }}</p>
                <p><strong>Budget:</strong> ${{ events['Budget'] }}</p>

                {% if session.get('role') == 'manager' %}
                <div id="mastodon_feed">
                    <h4>Post to Mastodon</h4>
                    <form method="POST" action="{{ url_for('post_to_mastodon', event_id=events['EventID']) }}">
                        <textarea name="message" rows="3" placeholder="Write your Mastodon post..."></textarea><br>
                        <button type="submit">Post</button>
                    </form>
                </div>
                {% endif %}

                <h2>Venue Details</h2>
                <p><strong>Venue:</strong> {{ venues['VenueName'] }}</p>
                <p><strong>Capacity:</strong> {{ venues['Capacity'] }}</p>
                <p><strong>Location:</strong> {{ venues['Location'] }}</p>
                {% if session.get('role') == 'manager' %}
                    <h2>Manage Event</h2>
                    <form action="{{ url_for('delete_event', event_id=events['EventID']) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this event?');">
                        <button type="submit" class="delete-btn">Delete Event</button>
                    </form>
                {% endif %}
            </section>

            <section id="more-info" class="tab-content">
                <h2>Organizer</h2>
                <p><strong>Name:</strong> {{organizer['OrganizerName']}}</p>
                <p><strong>Contact:</strong> {{organizer['ContactPerson'] }} - {{organizer['ContactNumber'] }}</p>
                <p><strong>Email:</strong> {{organizer['Email'] }}</p>

                <h2>Attendees</h2>
                <p>Total attendees: {{ attendees|length }}</p>
                <ul>
                    {% for attendee in attendees %}
                    <li>{{ attendee.FirstName }} {{ attendee.LastName }}</li>
                    {% endfor %}
                </ul>

                <h2>Sessions</h2>
                <ul>
                    {% for session in sessions %}
                    <li>{{ session['Title'] }} by {{ session['SpeakerName'] }}</li>
                    {% endfor %}
                </ul>

                <h2>Speakers</h2>
                <ul>
                    {% for speaker in speakers %}
                    <li>{{ speaker['SpeakerName'] }} - {{ speaker['Bio'] }}</li>
                    {% endfor %}
                </ul>

                <h2>Sponsors</h2>
                <ul>
                    {% for sponsor in sponsors %}
                    <li>{{ sponsor['SponsorName'] }}</li>
                    {% endfor %}
                </ul>

                <h2>Social Media Promotions</h2>
                <ul>
                    {% for promotion in social_media_promotions %}
                    <li>{{ promotion['Platform'] }}: {{ promotion['Content'] }} ({{ promotion['DatePosted'] }})</li>
                    {% endfor %}
                </ul>
            </section>

            <section id="tickets" class="tab-content">

                <form action="{{ url_for('buy_ticket_form', event_id=events['EventID']) }}" method="POST" class="ticket-form">
                    <label for="attendee_name">Your Name:</label>
                    <input type="text" id="attendee_name" name="attendee_name" required>

                    <label for="attendee_email">Email:</label>
                    <input type="email" id="attendee_email" name="attendee_email" required>

                    <label for="attendee_phone">Phone Number:</label>
                    <input type="text" id="attendee_phone" name="attendee_phone" required>

                    <button type="submit">Buy Ticket</button>
                </form>
            </section>
            <a href="{{ url_for('index') }}" class="back-button">‚Üê Back to Events</a>

                <script>
                    function openTab(evt, tabName) {
                        var i, tabcontent, tabbuttons;
                        tabcontent = document.getElementsByClassName("tab-content");
                        for (i = 0; i < tabcontent.length; i++) {
                            tabcontent[i].classList.remove("active");
                        }
                        tabbuttons = document.getElementsByClassName("tab-button");
                        for (i = 0; i < tabbuttons.length; i++) {
                            tabbuttons[i].classList.remove("active");
                        }
                        document.getElementById(tabName).classList.add("active");
                        evt.currentTarget.classList.add("active");
                    }

                    async function loadMastodonFeed(eventId) {
                        const feedDiv = document.getElementById('mastodon-feed');
                        feedDiv.innerHTML = 'Loading...';
                        try {
                            const response = await fetch(`/api/mastodon_feed/${eventId}`);
                            const posts = await response.json();
                            feedDiv.innerHTML = posts.map(post => `
                                <div class="mastodon-post">
                                    <strong>${post.user}</strong>: ${post.text} <br>
                                    <small>${post.time}</small>
                                </div>
                            `).join('');
                        } catch (err) {
                            feedDiv.innerHTML = 'Failed to load feed.';
                            console.error(err);
                        }
                    }

                    document.addEventListener('DOMContentLoaded', () => {
                        const eventId = {{ events['EventID'] }};
                        loadMastodonFeed(eventId);

                        setInterval(() => loadMastodonFeed(eventId), 30000);
                    });
                </script>
        </body>
</html>